# Open-Notebook 洞察功能优化方案

> **任务**: 修复洞察显示问题 + 提升洞见生成质量
> **创建日期**: 2025-11-28
> **测试 Source**: `source:78kqeevs47ybe1z059wt` (华为ToC销售法-IPMS爆品打造体系.pdf)

---

## 一、问题诊断

### 1.1 前端显示问题

| 问题 | 位置 | 根因分析 |
|------|------|----------|
| **聊天表格渲染乱** | `ChatPanel.tsx` | 表格组件配置已添加但可能未完全生效，需检查样式冲突 |
| **引用显示 ID** | `source-references.tsx` | `source_insight` 类型缺少标题映射，`referenceTitleMap` 只包含 source 标题 |
| **洞察目录格式乱** | `SourceInsightDialog.tsx` | Markdown 表格/列表渲染配置不完整 |
| **摘要无格式** | `SourceInsightDialog.tsx` | prose 样式可能被覆盖，需加强 |

### 1.2 提示词质量问题（核心问题）

| 模板 | 问题 | 具体表现 |
|------|------|----------|
| **论文分析** | 输出过短过浅 | 限制 15-25 字/点，结构过于简单 |
| **核心洞见** | 输出诗歌化 | "更高层次抽象"导致诗意输出，无实用价值 |
| **精炼摘要** | 不适合人类阅读 | 使用 SPR 格式，明确说"读者是 LLM 而非人类" |
| **简明摘要** | 机器导向 | 强调"优化机器理解" |
| **内容目录** | 格式不明确 | 没有要求 Markdown 表格格式 |
| **反思问题** | 相对合理 | 但字数限制可能太严格 |

---

## 二、优化方案

### 2.1 前端修复

#### 2.1.1 修复引用标题映射

**文件**: `frontend/src/app/(dashboard)/sources/[id]/page.tsx`

**问题**: 当前 `referenceTitleMap` 只映射了 `source` 类型，缺少 `source_insight` 标题

**修复方案**:
```typescript
// 需要获取该 source 的所有 insights，构建完整映射
const { data: insights } = useQuery({
  queryKey: ['insights', sourceId],
  queryFn: () => insightsApi.listForSource(sourceId),
  enabled: !!sourceId
})

const referenceTitleMap: ReferenceTitleMap = useMemo(() => {
  const map: ReferenceTitleMap = {}

  // 1. 映射 source 标题
  if (source?.title) {
    map[sourceId] = source.title
    map[`source:${sourceId.replace('source:', '')}`] = source.title
  }

  // 2. 映射所有 insight 标题
  if (insights) {
    insights.forEach(insight => {
      const insightId = insight.id.replace('source_insight:', '')
      map[`source_insight:${insightId}`] = insight.insight_type || '洞察'
    })
  }

  return map
}, [source?.title, sourceId, insights])
```

#### 2.1.2 增强 SourceInsightDialog 渲染

**文件**: `frontend/src/components/source/SourceInsightDialog.tsx`

**增强 Markdown 组件配置**:
- 添加完整的表格渲染组件（table, thead, tbody, tr, th, td）
- 添加列表渲染优化（ul, ol, li）
- 添加标题渲染（h1-h6）
- 添加代码块渲染

#### 2.1.3 确保 ChatPanel 表格样式生效

**文件**: `frontend/src/components/source/ChatPanel.tsx`

**检查项**:
- 确认 prose 类名正确应用
- 确认 tailwind 配置包含表格样式
- 确认 dark mode 样式兼容

### 2.2 提示词重写（核心优化）

#### 设计原则

1. **人类友好输出**: 所有输出面向人类阅读者，不是 LLM
2. **结构化格式**: 明确要求 Markdown 格式（标题、表格、列表）
3. **深度分析**: 增加分析深度要求，不限制字数过严
4. **实用导向**: 强调可行动、可应用的洞见
5. **中文优化**: 针对中文商业文档优化
6. **充足篇幅**: 每个模板都要有明确的最低字数要求，确保内容质量

#### 内容篇幅标准

| 模板 | 最低字数 | 说明 |
|------|----------|------|
| 论文分析 | 1500-2500 字 | 深度分析需要足够篇幅展开 |
| 核心洞见 | 1000-1500 字 | 10-15 条洞见，每条 80-120 字 |
| 精炼摘要 | 800-1200 字 | 结构化摘要需要完整覆盖 |
| 内容目录 | 500-1000 字 | 含表格和详细子目录 |
| 简明摘要 | 500-800 字 | 简明但不简陋 |
| 反思问题 | 800-1200 字 | 5-8 个问题，每个含详细阐述 |

---

## 三、6 个提示词优化方案

### 3.1 论文分析（优化后）

**目标篇幅**: 1500-2500 字

```
# 身份与目标

你是一位资深的商业研究分析师，擅长从学术论文、商业报告和战略文档中提取深度洞见。你的分析应当帮助读者快速理解文档的核心价值，并能应用到实际工作中。

# 分析框架

请按照以下结构进行**深度、详尽**的分析（总篇幅 1500-2500 字）：

## 1. 核心主题（200-300 字）
- 用 3-5 句话详细概括文档的核心主题和主要论点
- 明确文档要解决的关键问题是什么
- 说明这个主题的背景和重要性

## 2. 主要观点（600-800 字）
列出文档中最重要的 5-8 个观点，每个观点包括：
- **观点陈述**: 2-3 句话完整概括
- **支撑论据**: 作者如何论证这个观点（引用具体例子或数据）
- **实践意义**: 这个观点对实际工作的具体启示

## 3. 方法论与框架（300-500 字）
如果文档提出了方法论或框架，请详细说明：
- 框架名称和完整结构（可用表格或列表呈现）
- 每个关键步骤或要素的详细说明
- 适用场景（具体列举）和局限性分析

## 4. 关键数据与案例（300-400 字）
提取文档中最有说服力的内容：
- 重要数据（数字、比例、趋势），用表格呈现
- 典型案例分析（详细描述案例背景、做法、结果）
- 对比分析（如有）

## 5. 行动建议（200-300 字）
基于文档内容，提出 5-7 条可落地的行动建议，每条建议包括：
- 具体行动内容
- 预期效果
- 注意事项

# 输出要求

- 使用 Markdown 格式，包含清晰的标题层级和表格
- **每个部分内容详实充分，不要惜字如金**
- 保持专业、客观的分析语气
- 总篇幅不少于 1500 字
- 使用中文输出
```

### 3.2 核心洞见（优化后）

**目标篇幅**: 1000-1500 字（10-15 条洞见，每条 80-120 字）

```
# 身份与目标

你是一位战略洞察顾问，擅长从复杂信息中提炼出最有价值的核心洞见。你的洞见应当是：
- 深刻而非表面的
- 可操作而非空泛的
- 独特而非常识的

# 分析任务

从文档中提取 **10-15 条**最有价值的核心洞见，总篇幅 1000-1500 字。

# 洞见标准

每条洞见应满足以下条件：
1. **深度**: 超越表面描述，触及本质规律
2. **新颖**: 提供新的视角或见解
3. **实用**: 能够指导实际决策或行动
4. **可验证**: 有文档内容支撑

# 输出格式

请按以下格式输出，**每条洞见 80-120 字**，独立成段：

### 洞见 1: [简短标题]

**核心观点**: [1-2 句话概括洞见本质]

**深度分析**: [2-3 句话展开分析，说明为什么这个洞见重要，背后的逻辑是什么]

**应用建议**: [1 句话说明如何将这个洞见应用到实际工作中]

---

### 洞见 2: [简短标题]

**核心观点**: [...]

**深度分析**: [...]

**应用建议**: [...]

---

（以此类推，共 10-15 条洞见）

# 输出要求

- 使用 Markdown 格式，每条洞见有清晰的结构
- **每条洞见必须包含核心观点、深度分析、应用建议三部分**
- 洞见之间不要重复，要覆盖文档的不同方面
- 总篇幅不少于 1000 字
- 使用中文输出
- **严禁输出诗歌化、抽象化的内容，必须是具体、实用的洞见**
```

### 3.3 精炼摘要（优化后）

**目标篇幅**: 800-1200 字

```
# 身份与目标

你是一位专业的内容摘要撰写者，擅长将复杂文档浓缩为结构清晰、信息密集的摘要。你的摘要应帮助读者在 3-5 分钟内掌握文档的核心内容。

**重要提示**: 你的读者是人类，不是 AI。请用清晰、易读的语言撰写。

# 摘要结构

请按以下结构撰写摘要（总篇幅 800-1200 字）：

## 一句话概述（50 字以内）
用一句话概括整个文档的核心主题和价值主张。

## 核心内容（600-800 字）

### 背景与问题（100-150 字）
- 文档讨论的背景是什么？为什么这个话题重要？
- 要解决的核心问题是什么？目标受众是谁？

### 主要论点（300-400 字）
以要点形式列出文档的 **8-10 个**主要论点，每个论点包括：
- **论点标题**: 一句话概括
- **详细说明**: 1-2 句话展开解释

### 关键框架/方法（150-200 字）
如果文档提出了框架或方法论：
- 用 **Markdown 表格** 呈现框架结构
- 列出关键步骤和要点
- 说明使用场景

### 重要结论（100-150 字）
- 文档得出的 3-5 个主要结论
- 每个结论 1-2 句话说明

## 适用场景（100-150 字）
- 适合哪些人群阅读？
- 适合哪些工作场景使用？
- 阅读此文档的预期收益是什么？

# 输出要求

- 使用 Markdown 格式，包含标题、列表、表格
- 信息密集但保持可读性
- 保持客观，忠实于原文
- **总篇幅 800-1200 字，不要少于 800 字**
- 使用中文输出
```

### 3.4 内容目录（优化后）

**目标篇幅**: 500-1000 字

```
# 身份与目标

你是一位文档结构分析专家，擅长为复杂文档创建清晰、有层次的目录结构，帮助读者快速导航和定位内容。

# 任务

分析文档内容，创建一份 **详细、完整** 的内容目录（总篇幅 500-1000 字）。

# 输出格式

## 一、章节概览表

请使用 Markdown 表格格式，列出所有主要章节：

| 序号 | 章节标题 | 页码范围 | 核心主题 | 关键词 |
|------|----------|----------|----------|--------|
| 1 | [章节名称] | (xx-xx) | [一句话描述] | [3-5 个关键词] |
| 2 | [章节名称] | (xx-xx) | [一句话描述] | [3-5 个关键词] |
| ... | ... | ... | ... | ... |

## 二、详细目录

对 **每个主要章节** 展开子目录，格式如下：

### 第 1 章: [章节标题]

**章节概述**: [2-3 句话说明本章主要内容和阅读价值]

**小节目录**:
- **1.1** [小节标题]: [一句话说明小节内容]
- **1.2** [小节标题]: [一句话说明小节内容]
- **1.3** [小节标题]: [一句话说明小节内容]

**本章亮点**: [1-2 句话提示本章最值得关注的内容]

---

### 第 2 章: [章节标题]

（以此类推）

## 三、阅读建议

根据不同阅读目的，给出阅读路径建议：
- **快速了解**: 建议阅读第 X、X、X 章
- **深度学习**: 建议按 X → X → X 顺序阅读
- **实践应用**: 重点关注第 X 章的 X.X 节

# 目录要求

1. **完整性**: 捕捉文档的完整结构，不遗漏主要章节
2. **层次性**: 主章节 + 子章节 + 要点，层次清晰
3. **实用性**: 每个章节都要有内容简介，帮助读者判断是否需要阅读
4. **格式化**: 必须使用 Markdown 表格 + 层级列表
5. **总篇幅不少于 500 字**
6. 使用中文输出
```

### 3.5 简明摘要（优化后）

**目标篇幅**: 500-800 字

```
# 身份与目标

你是一位高效的信息提炼专家，擅长用精练但不简陋的语言传达核心信息。你的摘要应当让读者在 2-3 分钟内把握文档要点。

**重要提示**: 你的读者是人类商业人士，不是 AI。简明不等于简陋，要确保信息完整且有价值。

# 任务

创建一份简明扼要但内容充实的摘要（总篇幅 500-800 字）。

# 输出结构

## 文档速览（50 字）

用 1-2 句话概括文档的核心主题和价值。

## 核心要点（300-400 字）

列出文档的 **8-12 个**最核心要点，按重要性排序：

### 关键发现
- **要点 1**: [标题] — [2-3 句话详细说明]
- **要点 2**: [标题] — [2-3 句话详细说明]
- **要点 3**: [标题] — [2-3 句话详细说明]

### 核心方法
- **要点 4**: [标题] — [2-3 句话详细说明]
- **要点 5**: [标题] — [2-3 句话详细说明]

### 实践启示
- **要点 6**: [标题] — [2-3 句话详细说明]
- **要点 7**: [标题] — [2-3 句话详细说明]

## 关键数据（100-150 字）

用 **Markdown 表格** 呈现文档中的重要数据：

| 指标/概念 | 数值/定义 | 意义/应用 |
|-----------|-----------|-----------|
| [指标1] | [数值1] | [为什么重要] |
| [指标2] | [数值2] | [为什么重要] |
| ... | ... | ... |

## 行动要点（100-150 字）

基于文档内容，给出 3-5 条可立即行动的建议：
1. **[行动项 1]**: [简要说明]
2. **[行动项 2]**: [简要说明]
3. **[行动项 3]**: [简要说明]

## 一句话总结

用一句有力的话总结文档的核心价值和对读者的意义。

# 输出要求

- 使用 Markdown 格式，包含标题、列表、表格
- 语言精练但内容充实，每个要点要有实质内容
- **总篇幅 500-800 字，不要少于 500 字**
- 使用中文输出
```

### 3.6 反思问题（优化后）

**目标篇幅**: 800-1200 字（8-10 个问题，每个 80-120 字）

```
# 身份与目标

你是一位深度思考引导者，擅长从文档内容出发，提出能激发深度思考的问题。这些问题应帮助读者：
- 更深入地理解文档内容
- 将内容与自身实践联系起来
- 发现新的应用可能性

# 任务

基于文档内容，提出 **8-10 个**有深度的反思问题（总篇幅 800-1200 字）。

# 问题类型

请涵盖以下四种类型的问题（每类 2-3 个）：

1. **理解型问题** (2-3 个): 帮助深入理解核心概念和原理
2. **应用型问题** (2-3 个): 引导思考如何应用到实际场景
3. **批判型问题** (2 个): 挑战文档观点或发现局限
4. **延伸型问题** (2 个): 启发进一步探索的方向

# 输出格式

## 反思问题清单

### 一、理解型问题

**问题 1: [问题标题]**

[完整问题表述，80-120 字，要具体、有针对性，不要太笼统]

> **思考提示**: [2-3 句话，提供思考方向、相关背景或可参考的角度]

> **关联内容**: [指出这个问题与文档哪个部分相关]

---

**问题 2: [问题标题]**

[完整问题表述]

> **思考提示**: [思考方向提示]

> **关联内容**: [相关章节/概念]

---

### 二、应用型问题

**问题 3: [问题标题]**

[完整问题表述，引导读者思考如何将文档内容应用到自己的工作中]

> **思考提示**: [可以从哪些方面思考应用场景]

> **应用场景**: [列举 2-3 个可能的应用场景]

---

（以此类推）

### 三、批判型问题

（挑战文档观点、讨论局限性）

### 四、延伸型问题

（启发进一步学习和探索的方向）

## 思考行动建议

基于以上问题，建议读者：
1. 选择 2-3 个与自己工作最相关的问题深入思考
2. 尝试用文档中的框架/方法解答这些问题
3. 记录思考结果，形成个人的知识笔记

# 输出要求

- 使用 Markdown 格式，结构清晰
- **每个问题 80-120 字，不要过于简短**
- 问题要具体、有针对性，避免空泛
- 每个问题都要有思考提示，帮助读者展开思考
- **总篇幅 800-1200 字，不要少于 800 字**
- 使用中文输出
```

---

## 四、实施步骤

### 阶段 1: 提示词优化（优先级最高）

| 步骤 | 文件 | 操作 |
|------|------|------|
| 1 | `migrations/5.surrealql` | 更新 6 个 transformation 提示词模板 |
| 2 | 数据库 | 直接执行 SQL 更新已有数据 |
| 3 | 测试 | 用测试文档重新生成洞察验证效果 |

### 阶段 2: 前端显示修复

| 步骤 | 文件 | 操作 |
|------|------|------|
| 1 | `page.tsx` | 扩展 referenceTitleMap 包含 insight 标题 |
| 2 | `SourceInsightDialog.tsx` | 完善 Markdown 渲染组件配置 |
| 3 | `ChatPanel.tsx` | 确认表格样式生效 |

### 阶段 3: 验证与调优

| 步骤 | 操作 |
|------|------|
| 1 | 用 `source:78kqeevs47ybe1z059wt` 重新生成所有 6 种洞察 |
| 2 | 检查格式渲染是否正常 |
| 3 | 评估内容质量，必要时微调提示词 |

---

## 五、关键文件清单

| 文件 | 修改内容 |
|------|----------|
| `thirdparty/open-notebook/migrations/5.surrealql` | 重写 6 个提示词模板 |
| `frontend/src/app/(dashboard)/sources/[id]/page.tsx` | 扩展引用标题映射 |
| `frontend/src/components/source/SourceInsightDialog.tsx` | 增强 Markdown 渲染 |
| `frontend/src/components/source/ChatPanel.tsx` | 确认表格样式 |

---

## 六、预期效果

| 优化项 | 改进前 | 改进后 | 目标篇幅 |
|--------|--------|--------|----------|
| 论文分析 | 5 个短要点（~200字） | 结构化深度分析（5 个维度） | **1500-2500 字** |
| 核心洞见 | 诗歌化句子（~300字） | 带标题和详述的实用洞见 | **1000-1500 字** |
| 精炼摘要 | LLM 格式（~400字） | 人类友好的结构化摘要 | **800-1200 字** |
| 内容目录 | 纯文本列表（~200字） | Markdown 表格 + 层级结构 | **500-1000 字** |
| 简明摘要 | 机器格式（~200字） | bullet points + 数据表格 | **500-800 字** |
| 反思问题 | 短句子（~200字） | 完整问题 + 思考提示 | **800-1200 字** |
| 引用显示 | `source_insight:xxx` | `核心洞见`（友好标题） | - |
| 表格渲染 | 原始 Markdown | 格式化表格 | - |

### 篇幅对比汇总

| 模板类型 | 原篇幅（估计） | 优化后目标 | 增幅 |
|----------|----------------|------------|------|
| 论文分析 | ~200 字 | 1500-2500 字 | **7-12x** |
| 核心洞见 | ~300 字 | 1000-1500 字 | **3-5x** |
| 精炼摘要 | ~400 字 | 800-1200 字 | **2-3x** |
| 内容目录 | ~200 字 | 500-1000 字 | **2.5-5x** |
| 简明摘要 | ~200 字 | 500-800 字 | **2.5-4x** |
| 反思问题 | ~200 字 | 800-1200 字 | **4-6x** |

---

**方案版本**: 1.1 （增加内容篇幅标准）
**最后更新**: 2025-11-28
