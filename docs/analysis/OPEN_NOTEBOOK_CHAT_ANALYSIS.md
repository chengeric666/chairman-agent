# Open-Notebook Chat/Ask æœºåˆ¶æ·±åº¦åˆ†æ

> **åˆ†ææ—¥æœŸ**: 2025-11-26
> **åˆ†æç›®çš„**: ç†è§£Open-Notebookçš„å¯¹è¯æ¶æ„ï¼Œä¸ºåç»­ä¼˜åŒ–æä¾›ä¾æ®

---

## ç›®å½•

1. [æ¶æ„æ¦‚è§ˆ](#1-æ¶æ„æ¦‚è§ˆ)
2. [ä¸‰ç§å¯¹è¯æœºåˆ¶è¯¦è§£](#2-ä¸‰ç§å¯¹è¯æœºåˆ¶è¯¦è§£)
3. [Contextæ§åˆ¶æ¨¡å¼](#3-contextæ§åˆ¶æ¨¡å¼)
4. [æ•°æ®æµåˆ†æ](#4-æ•°æ®æµåˆ†æ)
5. [ä»£ç å®ç°ç»†èŠ‚](#5-ä»£ç å®ç°ç»†èŠ‚)
6. [å‘ç°çš„é—®é¢˜](#6-å‘ç°çš„é—®é¢˜)
7. [ä¼˜åŒ–å»ºè®®](#7-ä¼˜åŒ–å»ºè®®)

---

## 1. æ¶æ„æ¦‚è§ˆ

Open-Notebook æä¾›ä¸‰ç§ä¸åŒçš„å¯¹è¯æ–¹å¼ï¼Œæ¯ç§é’ˆå¯¹ä¸åŒçš„ä½¿ç”¨åœºæ™¯ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Open-Notebook å¯¹è¯æ¶æ„                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚   Source Chat    â”‚  â”‚  Notebook Chat   â”‚  â”‚       Ask        â”‚       â”‚
â”‚  â”‚  (ä¸æ¥æºå¯¹è¯)     â”‚  â”‚  (ä¸ç¬”è®°æœ¬å¯¹è¯)   â”‚  â”‚    (æ™ºèƒ½é—®ç­”)     â”‚       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚  â”‚ source_chat.py   â”‚  â”‚ chat.py          â”‚  â”‚ ask.py           â”‚       â”‚
â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚                  â”‚       â”‚
â”‚  â”‚ â€¢ å•ä¸ªSource     â”‚  â”‚ â€¢ å¤šä¸ªSources    â”‚  â”‚ â€¢ å…¨å±€æœç´¢       â”‚       â”‚
â”‚  â”‚ â€¢ é¢„åŠ è½½Insights â”‚  â”‚ â€¢ å¤šä¸ªNotes      â”‚  â”‚ â€¢ Vector Search  â”‚       â”‚
â”‚  â”‚ â€¢ æ·±åº¦ç†è§£       â”‚  â”‚ â€¢ å¯æ§ä¸Šä¸‹æ–‡     â”‚  â”‚ â€¢ ç²¾ç¡®æ£€ç´¢       â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚           â”‚                    â”‚                      â”‚                  â”‚
â”‚           â–¼                    â–¼                      â–¼                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                    ä¸Šä¸‹æ–‡æ¥æºå¯¹æ¯”                              â”‚       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚  â”‚ ContextBuilder   â”‚ /api/chat/contextâ”‚ vector_search()       â”‚       â”‚
â”‚  â”‚ (é¢„åŠ è½½)         â”‚ (é¢„åŠ è½½)          â”‚ (å®æ—¶æ£€ç´¢)            â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒåŒºåˆ«

| ç‰¹æ€§ | Source Chat | Notebook Chat | Ask |
|------|-------------|---------------|-----|
| **æ–‡ä»¶** | `source_chat.py` | `chat.py` | `ask.py` |
| **ä¸Šä¸‹æ–‡èŒƒå›´** | å•ä¸ªSource | å¤šä¸ªSources + Notes | å…¨å±€ |
| **Vector Search** | âŒ ä¸ä½¿ç”¨ | âŒ ä¸ä½¿ç”¨ | âœ… ä½¿ç”¨ |
| **ä¸Šä¸‹æ–‡æ„å»º** | ContextBuilder | /api/chat/context | å®æ—¶æ£€ç´¢ |
| **å¼•ç”¨ç±»å‹** | source, insight | source, insight, note | chunkä½ç½® |
| **é€‚ç”¨åœºæ™¯** | æ·±å…¥ç†è§£å•ä¸ªæ–‡æ¡£ | ç»¼åˆåˆ†æå¤šä¸ªæ–‡æ¡£ | ç²¾ç¡®æ£€ç´¢è·¨æ–‡æ¡£ |

---

## 2. ä¸‰ç§å¯¹è¯æœºåˆ¶è¯¦è§£

### 2.1 Source Chatï¼ˆä¸æ¥æºå¯¹è¯ï¼‰

**å…¥å£**: ç‚¹å‡»Sourceè¯¦æƒ…é¡µå³ä¾§çš„Chaté¢æ¿

**å·¥ä½œæµç¨‹**:
```
ç”¨æˆ·æé—®
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ContextBuilder.build()                                  â”‚
â”‚  â”œâ”€â”€ source.get_context("short")                        â”‚
â”‚  â”‚   â””â”€â”€ è¿”å›: {id, title, insights}                    â”‚
â”‚  â””â”€â”€ åŠ è½½æ‰€æœ‰Insightsçš„å®Œæ•´å†…å®¹                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  _format_source_context()                                â”‚
â”‚  â”œâ”€â”€ ## SOURCE CONTENT: {id, title}                     â”‚
â”‚  â””â”€â”€ ## SOURCE INSIGHTS: {id, type, content} Ã— N        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  source_chat.jinja Promptæ¨¡æ¿                            â”‚
â”‚  â””â”€â”€ # CITING INSTRUCTIONS                               â”‚
â”‚      - For source: [source:id]                           â”‚
â”‚      - For insights: [insight_id]                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
LLMå›ç­”ï¼ˆå¸¦å¼•ç”¨æ ‡è®° [1], [2]...ï¼‰
```

**ä»£ç ä½ç½®**:
- Graph: `open_notebook/graphs/source_chat.py`
- Prompt: `prompts/source_chat.jinja`
- API: `api/routers/source_chat.py`

**ä¸Šä¸‹æ–‡å†…å®¹**:
```python
# ContextBuilder è¿”å›
{
    "sources": [{
        "id": "source:xxx",
        "title": "æ–‡æ¡£æ ‡é¢˜",
        "insights": [...]  # æ‰€æœ‰Insightsçš„å®Œæ•´å†…å®¹
    }],
    "insights": [{
        "id": "source_insight:xxx",
        "insight_type": "æ ¸å¿ƒæ´è§",
        "content": "æ´å¯Ÿå†…å®¹..."
    }, ...],
    "total_tokens": 1500
}
```

---

### 2.2 Notebook Chatï¼ˆä¸ç¬”è®°æœ¬å¯¹è¯ï¼‰

**å…¥å£**: ç¬”è®°æœ¬é¡µé¢å³ä¾§çš„"ä¸ç¬”è®°æœ¬å¯¹è¯"é¢æ¿

**å·¥ä½œæµç¨‹**:
```
ç”¨æˆ·åœ¨å‰ç«¯é€‰æ‹©ä¸Šä¸‹æ–‡ (Contexté€‰æ‹©å™¨)
â”œâ”€â”€ Sources: "insights" æˆ– "full content" æˆ– "not in"
â””â”€â”€ Notes: "full content" æˆ– "not in"
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/chat/context                                  â”‚
â”‚  â”œâ”€â”€ source.get_context("short") â†’ {id, title, insights}â”‚
â”‚  â”œâ”€â”€ source.get_context("long") â†’ {id, title, insights, â”‚
â”‚  â”‚                                  full_text}           â”‚
â”‚  â””â”€â”€ note.get_context("long") â†’ {id, title, content}    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/chat/execute                                  â”‚
â”‚  state = {messages, context, model_override}             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  chat.py â†’ chat.jinja æ¨¡æ¿                               â”‚
â”‚  "# CONTEXT: {{context}}"                                â”‚
â”‚  "# CITING INSTRUCTIONS: [document_id]..."               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
LLMå›ç­”ï¼ˆå¸¦å¼•ç”¨ [source:id], [note:id]...ï¼‰
```

**ä»£ç ä½ç½®**:
- Graph: `open_notebook/graphs/chat.py`
- Prompt: `prompts/chat.jinja`
- API: `api/routers/chat.py`
- å‰ç«¯: `frontend/src/app/(dashboard)/notebooks/components/ChatColumn.tsx`

---

### 2.3 Askï¼ˆæ™ºèƒ½é—®ç­”ï¼‰

**å…¥å£**: ç¬”è®°æœ¬é¡µé¢çš„AskåŠŸèƒ½ï¼ˆå¦‚æœå¯ç”¨ï¼‰

**å·¥ä½œæµç¨‹**:
```
ç”¨æˆ·æé—®
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  agentèŠ‚ç‚¹: call_model_with_messages()                   â”‚
â”‚  â””â”€â”€ åˆ†æé—®é¢˜ï¼Œç”Ÿæˆæœç´¢ç­–ç•¥ (æœ€å¤š5ä¸ªæœç´¢è¯)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  provide_answerèŠ‚ç‚¹ (å¹¶è¡Œæ‰§è¡Œå¤šä¸ªæœç´¢)                    â”‚
â”‚  â””â”€â”€ vector_search(search_term, top_k=10)               â”‚
â”‚      â””â”€â”€ è¿”å›ç›¸å…³çš„åŸå§‹æ–‡æ¡£chunks                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  write_final_answerèŠ‚ç‚¹                                  â”‚
â”‚  â””â”€â”€ ç»¼åˆæ‰€æœ‰æœç´¢ç»“æœï¼Œç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
æœ€ç»ˆç­”æ¡ˆï¼ˆåŸºäºåŸå§‹chunksï¼‰
```

**ä»£ç ä½ç½®**:
- Graph: `open_notebook/graphs/ask.py`
- Prompts: `prompts/ask/entry.jinja`, `prompts/ask/query_process.jinja`, `prompts/ask/final_answer.jinja`

**å…³é”®ä»£ç **:
```python
# ask.py ç¬¬94è¡Œ
results = await vector_search(state["term"], 10, True, True)
```

---

## 3. Contextæ§åˆ¶æ¨¡å¼

### 3.1 ä¸‰ç§SourceåŒ…å«æ¨¡å¼

ç”¨æˆ·å¯ä»¥ç‚¹å‡»Sourceå¡ç‰‡å³ä¾§çš„å›¾æ ‡ï¼Œå¾ªç¯åˆ‡æ¢ä¸‰ç§æ¨¡å¼ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Source Context ä¸‰ç§æ¨¡å¼                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  ğŸ’¡ Insightsæ¨¡å¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  â”‚                                                                       â”‚
â”‚  â”‚  Source.get_context("short") è¿”å›:                                   â”‚
â”‚  â”‚  {                                                                    â”‚
â”‚  â”‚    id: "source:xxx",                                                 â”‚
â”‚  â”‚    title: "æ–‡æ¡£æ ‡é¢˜",                                                 â”‚
â”‚  â”‚    insights: [                                                        â”‚
â”‚  â”‚      {id: "source_insight:xxx", insight_type: "æ ¸å¿ƒæ´è§", content...},â”‚
â”‚  â”‚      {id: "source_insight:yyy", insight_type: "è®ºæ–‡åˆ†æ", content...},â”‚
â”‚  â”‚      ...                                                              â”‚
â”‚  â”‚    ]                                                                  â”‚
â”‚  â”‚  }                                                                    â”‚
â”‚  â”‚                                                                       â”‚
â”‚  â”‚  ç‰¹ç‚¹: åªåŒ…å«é¢„å¤„ç†çš„æ´å¯Ÿï¼ŒTokenæ¶ˆè€—ä½ï¼Œèšç„¦é«˜å±‚ä¿¡æ¯                  â”‚
â”‚  â”‚                                                                       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â”‚                                                                       â”‚
â”‚  ğŸ“„ Full Contentæ¨¡å¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  â”‚                                                                       â”‚
â”‚  â”‚  Source.get_context("long") è¿”å›:                                    â”‚
â”‚  â”‚  {                                                                    â”‚
â”‚  â”‚    id: "source:xxx",                                                 â”‚
â”‚  â”‚    title: "æ–‡æ¡£æ ‡é¢˜",                                                 â”‚
â”‚  â”‚    insights: [...],           // ä¹ŸåŒ…å«insightsï¼                    â”‚
â”‚  â”‚    full_text: "å®Œæ•´æ–‡æ¡£å†…å®¹..." // é¢å¤–åŒ…å«åŸæ–‡                       â”‚
â”‚  â”‚  }                                                                    â”‚
â”‚  â”‚                                                                       â”‚
â”‚  â”‚  ç‰¹ç‚¹: åŒ…å«å®Œæ•´åŸæ–‡ï¼ŒTokenæ¶ˆè€—é«˜ï¼Œå¯è·å–ç»†èŠ‚                          â”‚
â”‚  â”‚                                                                       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â”‚                                                                       â”‚
â”‚  ğŸš« Not Includedæ¨¡å¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  â”‚                                                                       â”‚
â”‚  â”‚  ä¸åŒ…å«è¯¥Sourceçš„ä»»ä½•å†…å®¹                                             â”‚
â”‚  â”‚                                                                       â”‚
â”‚  â”‚  ç‰¹ç‚¹: å®Œå…¨æ’é™¤ï¼Œç²¾å‡†æ§åˆ¶ä¸Šä¸‹æ–‡                                       â”‚
â”‚  â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 å®é™…æµ‹è¯•æ•°æ®å¯¹æ¯”

| æ¨¡å¼ | SourceåŒ…å«å†…å®¹ | å¼•ç”¨æ•° | Tokens | Chars |
|------|---------------|--------|--------|-------|
| **Full Content** | full_text + insights | 5ä¸ª | 3.0K | 5.6K |
| **Insights** | åªæœ‰insights | 6ä¸ª | 1.5K | 3.6K |
| **Not Included** | æ—  | 2ä¸ª | 280 | 510 |

### 3.3 Context Indicator æ˜¾ç¤ºè¯´æ˜

```
Context: ğŸ’¡1 â€¢ ğŸ“2         1.5K tokens / 3.6K chars
         â†‘     â†‘
         â”‚     â””â”€â”€ 2ä¸ªNotesè¢«åŒ…å«
         â”‚
         â””â”€â”€ 1ä¸ªSourceè®¾ä¸º"insightsæ¨¡å¼"ï¼ˆä¸æ˜¯insightæ•°é‡ï¼ï¼‰
```

**æ³¨æ„**: `ğŸ’¡1` æ˜¾ç¤ºçš„æ˜¯**Sourceæ•°é‡**ï¼Œä¸æ˜¯**Insightæ•°é‡**ã€‚è¿™å¯èƒ½é€ æˆç”¨æˆ·å›°æƒ‘ã€‚

---

## 4. æ•°æ®æµåˆ†æ

### 4.1 Source â†’ Insights ç”Ÿæˆæµç¨‹

```
Sourceä¸Šä¼ 
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ–‡æ¡£å¤„ç†                                                â”‚
â”‚  â”œâ”€â”€ æ–‡æœ¬æå– (PDF/HTML/etc)                            â”‚
â”‚  â”œâ”€â”€ åˆ†å— (Chunking)                                    â”‚
â”‚  â””â”€â”€ Embeddingç”Ÿæˆ â†’ å­˜å…¥å‘é‡æ•°æ®åº“                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Transformationæ‰§è¡Œ (å¯é€‰ï¼Œéœ€æ‰‹åŠ¨è§¦å‘æˆ–è‡ªåŠ¨)             â”‚
â”‚  â”œâ”€â”€ æ ¸å¿ƒæ´è§                                           â”‚
â”‚  â”œâ”€â”€ è®ºæ–‡åˆ†æ                                           â”‚
â”‚  â”œâ”€â”€ ç²¾ç‚¼æ‘˜è¦ (é»˜è®¤æ‰§è¡Œ)                                â”‚
â”‚  â”œâ”€â”€ åæ€é—®é¢˜                                           â”‚
â”‚  â””â”€â”€ ...                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”Ÿæˆ SourceInsight è®°å½•                                 â”‚
â”‚  â””â”€â”€ å­˜å…¥æ•°æ®åº“ï¼Œä¸Sourceå…³è”                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 Chatä¸Šä¸‹æ–‡æ„å»ºæµç¨‹

```
ç”¨æˆ·å‘èµ·å¯¹è¯
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯ ContextSelections                                  â”‚
â”‚  {                                                       â”‚
â”‚    sources: { "source:xxx": "insights" },               â”‚
â”‚    notes: { "note:yyy": "full" }                        â”‚
â”‚  }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/chat/context                                  â”‚
â”‚  â””â”€â”€ æ„å»ºä¸Šä¸‹æ–‡ï¼Œè®¡ç®—tokenæ•°                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/chat/execute                                  â”‚
â”‚  â””â”€â”€ æ‰§è¡ŒLangGraphï¼Œè°ƒç”¨LLM                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
è¿”å›AIå›ç­”
```

---

## 5. ä»£ç å®ç°ç»†èŠ‚

### 5.1 å…³é”®æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|
| `open_notebook/graphs/source_chat.py` | Source Chatçš„LangGraphå®ç° |
| `open_notebook/graphs/chat.py` | Notebook Chatçš„LangGraphå®ç° |
| `open_notebook/graphs/ask.py` | AskåŠŸèƒ½çš„LangGraphå®ç°ï¼ˆä½¿ç”¨vector_searchï¼‰ |
| `open_notebook/utils/context_builder.py` | é€šç”¨ä¸Šä¸‹æ–‡æ„å»ºå™¨ |
| `open_notebook/domain/notebook.py` | Sourceã€Noteã€Insightç­‰é¢†åŸŸæ¨¡å‹ |
| `api/routers/source_chat.py` | Source Chat APIè·¯ç”± |
| `api/routers/chat.py` | Notebook Chat APIè·¯ç”± |
| `prompts/source_chat.jinja` | Source Chatçš„Promptæ¨¡æ¿ |
| `prompts/chat.jinja` | Notebook Chatçš„Promptæ¨¡æ¿ |
| `prompts/ask/*.jinja` | AskåŠŸèƒ½çš„Promptæ¨¡æ¿ |

### 5.2 Source.get_context() å®ç°

```python
# open_notebook/domain/notebook.py ç¬¬216-229è¡Œ
async def get_context(
    self, context_size: Literal["short", "long"] = "short"
) -> Dict[str, Any]:
    insights_list = await self.get_insights()
    insights = [insight.model_dump() for insight in insights_list]

    if context_size == "long":  # Full Contentæ¨¡å¼
        return dict(
            id=self.id,
            title=self.title,
            insights=insights,
            full_text=self.full_text,
        )
    else:  # Insightsæ¨¡å¼
        return dict(id=self.id, title=self.title, insights=insights)
```

### 5.3 Note.get_context() å®ç°

```python
# open_notebook/domain/notebook.py ç¬¬371-381è¡Œ
def get_context(
    self, context_size: Literal["short", "long"] = "short"
) -> Dict[str, Any]:
    if context_size == "long":
        return dict(id=self.id, title=self.title, content=self.content)
    else:
        return dict(
            id=self.id,
            title=self.title,
            content=self.content[:100] if self.content else None,
        )
```

### 5.4 Noteæ•°æ®æ¨¡å‹

```python
# open_notebook/domain/notebook.py ç¬¬353-357è¡Œ
class Note(ObjectModel):
    table_name: ClassVar[str] = "note"
    title: Optional[str] = None
    note_type: Optional[Literal["human", "ai"]] = None  # åŒºåˆ†æ‰‹å†™vs AIç”Ÿæˆ
    content: Optional[str] = None
```

**é‡è¦**: `note_type`åªæ˜¯æ ‡è®°ï¼Œåœ¨Chatä¸­æ‰‹å†™ç¬”è®°å’ŒAIç¬”è®°å®Œå…¨ç­‰åŒã€‚

---

## 6. å‘ç°çš„é—®é¢˜

### 6.1 Sourceæ— Insightsæ—¶Chatå¤±æ•ˆ

**é—®é¢˜æè¿°**: å½“Sourceæ²¡æœ‰è¿è¡ŒTransformationç”ŸæˆInsightsæ—¶ï¼ŒSource Chatåªè¿”å›çº¦45 tokensçš„å…ƒæ•°æ®ï¼Œæ— æ³•æä¾›æœ‰ä»·å€¼çš„å›ç­”ã€‚

**æ ¹å› **: Source Chatä¾èµ–é¢„å¤„ç†çš„Insightsï¼Œä¸ä½¿ç”¨vector_searchã€‚

**ç¤ºä¾‹**:
```
Source: è‘£äº‹é•¿æ±‡æŠ¥06.pdf
- åŸæ–‡: 45,118 chars
- Chunks: 74ä¸ª
- Insights: 0ä¸ª â† é—®é¢˜æ‰€åœ¨ï¼
- Chatè¿”å›: ~45 tokens (åªæœ‰idå’Œtitle)
```

### 6.2 Context Indicatoræ˜¾ç¤ºå¯èƒ½è¯¯å¯¼

**é—®é¢˜æè¿°**: `Context: ğŸ’¡1` æ˜¾ç¤ºçš„æ˜¯"1ä¸ªSourceè®¾ä¸ºinsightsæ¨¡å¼"ï¼Œè€Œä¸æ˜¯"1ä¸ªinsight"ï¼Œç”¨æˆ·å¯èƒ½è¯¯è§£ã€‚

**å»ºè®®**: å¯ä»¥æ”¹ä¸ºæ˜¾ç¤ºå®é™…çš„insightæ•°é‡ï¼Œå¦‚ `ğŸ’¡3 insights from 1 source`ã€‚

### 6.3 Full Contentæ¨¡å¼å¼•ç”¨åè€Œæ›´å°‘

**è§‚å¯Ÿ**: åœ¨æµ‹è¯•ä¸­ï¼ŒFull Contentæ¨¡å¼(5ä¸ªå¼•ç”¨) < Insightsæ¨¡å¼(6ä¸ªå¼•ç”¨)

**å¯èƒ½åŸå› **:
1. ä¸Šä¸‹æ–‡ç«äº‰ï¼šfull_textç¨€é‡Šäº†LLMå¯¹insightsçš„æ³¨æ„åŠ›
2. Tokené™åˆ¶ï¼šfull_textå ç”¨å¤§é‡tokensï¼Œinsightså¯èƒ½è¢«æˆªæ–­

---

## 7. ä¼˜åŒ–å»ºè®®

### 7.1 çŸ­æœŸä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | æè¿° | ä¼˜å…ˆçº§ |
|--------|------|--------|
| è‡ªåŠ¨è¿è¡Œé»˜è®¤Transformation | Sourceä¸Šä¼ åè‡ªåŠ¨è¿è¡Œ"ç²¾ç‚¼æ‘˜è¦" | é«˜ |
| Context Indicatoræ”¹è¿› | æ˜¾ç¤ºå®é™…insightæ•°é‡è€Œésourceæ•°é‡ | ä¸­ |
| æ— Insightsæ—¶æç¤º | åœ¨Chatä¸­æç¤ºç”¨æˆ·å…ˆç”ŸæˆInsights | ä¸­ |

### 7.2 ä¸­æœŸä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | æè¿° | ä¼˜å…ˆçº§ |
|--------|------|--------|
| Fallbackæœºåˆ¶ | å½“Insightsä¸ºç©ºæ—¶ï¼Œè‡ªåŠ¨ä½¿ç”¨vector_search | é«˜ |
| æ··åˆæ£€ç´¢ç­–ç•¥ | åŒæ—¶ä½¿ç”¨Insights + top-k chunks | ä¸­ |
| æ™ºèƒ½æ¨¡å¼æ¨è | æ ¹æ®é—®é¢˜ç±»å‹æ¨èä½¿ç”¨Full/Insightsæ¨¡å¼ | ä½ |

### 7.3 é•¿æœŸä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | æè¿° | ä¼˜å…ˆçº§ |
|--------|------|--------|
| é—®é¢˜è·¯ç”±å™¨ | æ™ºèƒ½åˆ¤æ–­é—®é¢˜ç±»å‹ï¼Œé€‰æ‹©æœ€ä½³æ£€ç´¢ç­–ç•¥ | ä¸­ |
| RAPTORæ¶æ„ | å®ç°å¤šå±‚æ¬¡æ‘˜è¦çš„åˆ†å±‚æ£€ç´¢ | ä½ |
| ä¸Šä¸‹æ–‡èåˆ | Insightsæä¾›æ¡†æ¶ + Chunksæä¾›ç»†èŠ‚ | ä½ |

### 7.4 è®¾è®¡å‚è€ƒï¼šæ··åˆæ£€ç´¢æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ¨èçš„Chatæ¶æ„                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  ç”¨æˆ·é—®é¢˜ â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                 â”‚                                            â”‚
â”‚                 â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚           Question Router (é—®é¢˜è·¯ç”±å™¨)                â”‚    â”‚
â”‚  â”‚  â€¢ ä¸»é¢˜/æ¦‚å¿µç±»é—®é¢˜ â†’ ä¼˜å…ˆä½¿ç”¨ Insights               â”‚    â”‚
â”‚  â”‚  â€¢ ç»†èŠ‚/äº‹å®ç±»é—®é¢˜ â†’ ä¼˜å…ˆä½¿ç”¨ Vector Search          â”‚    â”‚
â”‚  â”‚  â€¢ æ··åˆé—®é¢˜ â†’ ä¸¤è€…ç»“åˆ                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                 â”‚                                            â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚        â–¼                 â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚ Insights â”‚     â”‚ Vector Chunks â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                 â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              Context Fusion (ä¸Šä¸‹æ–‡èåˆ)              â”‚    â”‚
â”‚  â”‚  â€¢ Insights æä¾›æ¡†æ¶å’Œä¸»é¢˜                           â”‚    â”‚
â”‚  â”‚  â€¢ Chunks æä¾›ç»†èŠ‚å’Œå¼•ç”¨                             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                 â”‚                                            â”‚
â”‚                 â–¼                                            â”‚
â”‚            LLM Response                                      â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## é™„å½•

### A. Transformationï¼ˆè½¬åŒ–ï¼‰ä¸­æ–‡æç¤ºè¯

å·²é…ç½®çš„6ä¸ªä¸­æ–‡Transformationï¼š

| åç§° | æè¿° | é»˜è®¤æ‰§è¡Œ |
|------|------|----------|
| è®ºæ–‡åˆ†æ | æ·±åº¦åˆ†æå­¦æœ¯/æŠ€æœ¯è®ºæ–‡ï¼Œæå–æ ¸å¿ƒè§‚ç‚¹ | å¦ |
| æ ¸å¿ƒæ´è§ | æå–é‡è¦æ´å¯Ÿå’Œå¯è¡ŒåŠ¨å»ºè®® | å¦ |
| ç²¾ç‚¼æ‘˜è¦ | åˆ›å»ºå†…å®¹ä¸°å¯Œã€æ·±åº¦æµ“ç¼©çš„æ‘˜è¦ | **æ˜¯** |
| åæ€é—®é¢˜ | ç”Ÿæˆå¸®åŠ©æ·±å…¥æ¢ç´¢æ–‡æ¡£çš„åæ€æ€§é—®é¢˜ | å¦ |
| å†…å®¹ç›®å½• | æè¿°æ–‡æ¡£æ¶µç›–çš„ä¸åŒä¸»é¢˜ | å¦ |
| ç®€æ˜æ‘˜è¦ | ç”Ÿæˆå†…å®¹çš„ç®€çŸ­æ‘˜è¦ | å¦ |

### B. æ•°æ®åº“ç»“æ„å‚è€ƒ

```
namespace: open_notebook
database: production

Tables:
- source: æ¥æºæ–‡æ¡£
- source_insight: æ¥æºæ´å¯Ÿï¼ˆTransformationç”Ÿæˆï¼‰
- source_embedding: æ¥æºå‘é‡åµŒå…¥
- note: ç¬”è®°ï¼ˆhuman/aiä¸¤ç§ç±»å‹ï¼‰
- notebook: ç¬”è®°æœ¬
- transformation: è½¬åŒ–é…ç½®
- chat_session: èŠå¤©ä¼šè¯
```

---

**æ–‡æ¡£ç»´æŠ¤**: Claude Code
**æœ€åæ›´æ–°**: 2025-11-26
